# インストール

## 依存関係

Nahlundのインストール/実行には以下の依存関係が必要です。

+ [curl](https://curl.se/)
+ [docker](https://docs.docker.com/get-started/get-docker/)
+ [docker-compose](https://docs.docker.com/compose/install/)

## サービスのインストール

Nahlundの実態は、docker-composeにより構築されたコンテナ群をsystemdでサービス化したものです。

以下のインストールスクリプトを実行することで、Nahlundをシステムにインストールできます。
スクリプトの内容を理解した上で実行してください。

```console
curl -L https://raw.githubusercontent.com/azishio/nahlund/refs/heads/main/install.sh | bash
```

以下のコマンドでシステムにNahlundサービスがインストールされていることを確認できます。

```console
systemctl status nahlund
```

## 河川データの取得

Nahlundは、河川の3Dデータを生成するために、河川のデータを使用します。
以下のコマンドで、国土地理院が公開するデータからNahlundに必要なデータを計算できます。

もしくは、デフォルトのオプションで生成されたデータを[リポジトリ](https://github.com/azishio/rnet)
のReleaseからダウンロードすることもできます。

```console
curl -Lo run_rnet.sh https://raw.githubusercontent.com/azishio/rnet/refs/heads/main/run.sh
bash ./run_rnet.sh
rm run_rnet.sh
```

> このスクリプトの実行には、数十分から数時間かかる場合があります。
> また、多くのデータをダウンロードするため安定したネットワーク環境が必要です。
>
{style="note"}

この方法で生成されたデータを使用してWebアプリケーションを公開する場合、適切な出典の表示が必要です。
詳しくは、[Webアプリケーションを公開する際の注意点](Webアプリケーションを公開する際の注意点.md)を参照してください。

### 取得する河川の属性や並列ダウンロード数を指定する。

シェルスクリプトを実行する際、以下のようにコマンドライン引数を指定することで、取得する河川の属性や並列ダウンロード数を指定できます。

```console
bash ./run_rnet.sh --batch 500
```

#### コマンドライン引数一覧

| long             | short | description                                                               | default                                                    |
|------------------|-------|---------------------------------------------------------------------------|------------------------------------------------------------|
| --batch          | -b    | 並列してダウンロードするデータの数。これを増やすことで、処理時間を短縮できます。                                  | 100                                                        |
| --line           | -l    | 取得する河川中心線の種別をコンマ区切りで指定します。種別を表す文字列は[次の表](#table-river-category)を参照してください。 | "sn,sd,n,ao,w,o,u"                                         |
| --category       | -c    | 取得する河川のカテゴリをコンマ区切り指定します。カテゴリを表す文字列は[次の表](#table-river-line)を参照してください。     | "all"                                                      |
| --river_base_url | -r    | 河川中心線のベクタータイルを取得するためのURL。                                                 | "https://cyberjapandata.gsi.go.jp/xyz/experimental_rvrcl/" |
| --dem_base_url   | -d    | 標高タイルを取得するためのURL。                                                         | "https://tiles.gsj.jp/tiles/elev/land/"                    |
| --zoom_lv        | -z    | 標高タイルを取得する際のズームレベル。                                                       | 14                                                         |

> `--batch`で大きな値を指定した場合、ファイルディスクリプタの上限に達する可能性があります。
> その場合、`ulimit -n`コマンドからファイルディスクリプタの上限を増やすことで解決できます。
>
{style="warning"}

#### 河川中心線の種別 {id="table-river-line"}

| 記号    | 意味            |
|-------|---------------|
| "sn"  | "細河川（通常部）"    |
| "sd"  | "細河川（枯れ川部）"   |
| "n"   | "河川中心線（通常部）"  |
| "d"   | "河川中心線（枯れ川部）" |
| "ao"  | "人工水路（空間）"    |
| "au"  | "人工水路（地下）"    |
| "w"   | "用水路"         |
| "o"   | "その他"         |
| "u"   | "不明"          |
| "all" | "全て"          |

#### 河川のカテゴリ {id="table-river-category"}

| 記号    | 意味     |
|-------|--------|
| "p"   | "一級河川" |
| "s"   | "二級河川" |
| "q"   | "準用河川" |
| "r"   | "普通河川" |
| "o"   | "その他"  |
| "u"   | "不明"   |
| "all" | "全て"   |

## サービスの起動

以下のコマンドでNahlundサービスを起動できます。

```console
systemctl start nahlund
```

以下のコマンドでNahlundサービスが正常に起動していることを確認できます。

```console
systemctl status nahlund
```

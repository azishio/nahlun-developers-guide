# 動作のカスタマイズ

## 環境変数
Nahlundの動作は、`/etc/nahlund/`以下に存在する`.env`環境変数ファイルによってカスタマイズできます。

この環境変数は、Nahlundが管理するコンテナに配布されます。

SERVER_PORT
: 水位計のデータの送信先や、3Dモデルの配信元のエンドポイントを公開するポートを指定します。

SOCKETIO_PORT
: データの更新通知を行うエンドポイントを公開するポートを指定します。

> `SERVER_PORT`、`SOCKETIO_PORT`で指定されたポートは、デフォルトで全ての外部のアドレスに公開されます。
> このため、システムの起動中はファイアーウォールが設定されている場合、そのルールが変更されます。
> これが意図した挙動でない場合、[Dockerのドキュメント](https://docs.docker.jp/network/iptables.html)を参照して設定を変更してください。
> 
{style="warning"}

CLIENT_HOST
: Nahlundからデータを受け取る、Nahlun Layerを組み込んだWebアプリケーションのアドレスです。
: ここに指定していないアドレスからのデータ要求は認められません。

DISK_CACHE_MAX_SIZE
: Nahlundは、頻繁に配信するデータを一時的にローカルストレージに保持し、応答速度を高めています。
: この目的で使用されるストレージ容量をbyte単位で指定できます。

MEMORY_CACHE_MAX_SIZE
: Nahlundは、頻繁に配信するデータを一時的にメモリ上に保持し、応答速度を高めています。
: この目的で使用されるメモリサイズをbyte単位で指定できます。
: デフォルトは、システムのRAMの1/4です。

NEO4J_server_memory_heap_initial__size
NEO4J_server_memory_heap_max__size
NEO4J_server_memory_pagecache_size
: 内部で使用されているグラフデータベースである、NEO4Jが使用できるメモリサイズを指定できます。
: デフォルトではシステムのRAMの1/4かつ31GB以下の値が設定されています。

## 河川のデータ

## 河川データの差し替え

Nahlundは、インストール時に[rnetリポジトリ](https://github.com/azishio/rnet)の最新のReleaseから河川の情報を取得しています。
これらは、rnetコマンドをデフォルトのオプションで実行した際の出力ファイルです。

以下のコマンドで、任意のオプションを指定して国土地理院が公開するデータからNahlundに必要なデータを計算できます。

```console
curl -Lo run_rnet.sh https://raw.githubusercontent.com/azishio/rnet/refs/heads/main/run.sh
bash ./run_rnet.sh
rm run_rnet.sh
```

> このスクリプトの実行には、数十分から数時間かかる場合があります。
> また、多くのデータをダウンロードするため安定したネットワーク環境が必要です。
>
{style="note"}

### データの差し替え
Nahlundは、初回起動時に河川の情報を`/opt/nahlund/import`以下から参照し、同一階層に`done`ファイルを生成します。
`done`ファイルはNahlundが初期化済みであることを示すフラグファイルで、これを削除するとNahlundはすべてのデータを初期化します。

データを差し替えるには、`/opt/nahlund/import`以下をファイルを書き換えた後、`done`ファイルを削除したうえで以下のコマンドを実行してください。

```console
systemctl stop nahlund
systemctl start nahlund
```

### 取得する河川の属性や並列ダウンロード数を指定する。

シェルスクリプトを実行する際、以下のようにコマンドライン引数を指定することで、取得する河川の属性や並列ダウンロード数を指定できます。

```console
bash ./run_rnet.sh --batch 500
```

#### コマンドライン引数一覧

| long             | short | description                                                               | default                                                    |
|------------------|-------|---------------------------------------------------------------------------|------------------------------------------------------------|
| --batch          | -b    | 並列してダウンロードするデータの数。これを増やすことで、処理時間を短縮できます。                                  | 100                                                        |
| --line           | -l    | 取得する河川中心線の種別をコンマ区切りで指定します。種別を表す文字列は[次の表](#table-river-category)を参照してください。 | "sn,sd,n,ao,w,o,u"                                         |
| --category       | -c    | 取得する河川のカテゴリをコンマ区切り指定します。カテゴリを表す文字列は[次の表](#table-river-line)を参照してください。     | "all"                                                      |
| --river_base_url | -r    | 河川中心線のベクタータイルを取得するためのURL。                                                 | "https://cyberjapandata.gsi.go.jp/xyz/experimental_rvrcl/" |
| --dem_base_url   | -d    | 標高タイルを取得するためのURL。                                                         | "https://tiles.gsj.jp/tiles/elev/land/"                    |
| --zoom_lv        | -z    | 標高タイルを取得する際のズームレベル。                                                       | 14                                                         |

> `--batch`で大きな値を指定した場合、ファイルディスクリプタの上限に達する可能性があります。
> その場合、`ulimit -n`コマンドからファイルディスクリプタの上限を増やすことで解決できます。
>
{style="warning"}

#### 河川中心線の種別 {id="table-river-line"}

| 記号    | 意味            |
|-------|---------------|
| "sn"  | "細河川（通常部）"    |
| "sd"  | "細河川（枯れ川部）"   |
| "n"   | "河川中心線（通常部）"  |
| "d"   | "河川中心線（枯れ川部）" |
| "ao"  | "人工水路（空間）"    |
| "au"  | "人工水路（地下）"    |
| "w"   | "用水路"         |
| "o"   | "その他"         |
| "u"   | "不明"          |
| "all" | "全て"          |

#### 河川のカテゴリ {id="table-river-category"}

| 記号    | 意味     |
|-------|--------|
| "p"   | "一級河川" |
| "s"   | "二級河川" |
| "q"   | "準用河川" |
| "r"   | "普通河川" |
| "o"   | "その他"  |
| "u"   | "不明"   |
| "all" | "全て"   |
